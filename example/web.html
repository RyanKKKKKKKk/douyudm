<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>演示页面</title>
</head>

<body>
    <div>
        <input id="roomId" type="number" placeholder="请输入房间号">
        <button id="s">确定</button>
        <span id="tips"></span>
    </div>
    <hr>
    <ul id="messages" style="text-decoration:none;margin:0;padding:0;overflow-y:scroll;"></ul>
    <script>
        var ws = null
        var isConn = false

        function getId(el) {
            return document.getElementById(el)
        }

        getId('s').onclick = function () {
            var roomId = getId('roomId').value
            var url = window.location.origin.replace(/https?:\/\//, 'ws://')
            if (roomId && roomId > 0) {
                if (isConn) exit()
                getId('tips').innerText = ''
                init(url, roomId)
            } else {
                getId('tips').innerText = '请输入正确的房间号'
            }
        }

        function init(url, roomId) {
            getId('messages').innerHTML = ''
            ws = new WebSocket(url)
            ws.onopen = function () {
                sendMessage({
                    type: 'connect',
                    roomId: roomId,
                })
            }
            ws.onmessage = function (data) {
                var node = document.createElement('li')
                node.innerText = data.data
                getId('messages').appendChild(node, null)
                document.querySelectorAll('li')[document.querySelectorAll('li').length - 1].scrollIntoView()
            }
            ws.onclose = function () {
                console.log('断开')
            }
            isConn = true
        }

        function exit() {
            sendMessage({
                type: 'exit',
            })
            ws.close()
            isConn = false
        }

        function sendMessage(obj) {
            ws.send(JSON.stringify(obj))
        }

        getId('messages').style.height = (document.documentElement.clientHeight - 60) + 'px'
    </script>
</body>

</html>